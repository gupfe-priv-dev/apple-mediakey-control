name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options: [patch, minor, major]
      notes:
        description: 'Release notes (added to README and GitHub Release)'
        required: true

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Compute next version
        id: ver
        run: |
          LAST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1 || echo "v0.0.0")
          BASE="${LAST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"
          case "${{ inputs.bump }}" in
            major) MAJOR=$((MAJOR+1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR+1)); PATCH=0 ;;
            *)     PATCH=$((PATCH+1)) ;;
          esac
          VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}"    >> "$GITHUB_OUTPUT"

      - name: Update README version table
        run: |
          V="${{ steps.ver.outputs.version }}"
          N="${{ inputs.notes }}"
          awk -v v="$V" -v n="$N" '
            /^## Version history/ { in_ver=1 }
            /^\|---/ && in_ver && !done { print; print "| " v " | " n " |"; done=1; next }
            { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Build app
        run: VERSION="${{ steps.ver.outputs.version }}" ./build.sh

      - name: Package zip
        run: |
          zip -r MediaKeyControl.zip MediaKeyControl.app
          echo "Zip size: $(du -sh MediaKeyControl.zip | cut -f1)"

      - name: Commit, tag, push
        run: |
          git config user.name  "Gunnar Budach"
          git config user.email "262993607+gupfe-priv-dev@users.noreply.github.com"
          git add README.md
          git commit -m "Release ${{ steps.ver.outputs.tag }}"
          git tag "${{ steps.ver.outputs.tag }}"
          git push
          git push origin "${{ steps.ver.outputs.tag }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.ver.outputs.tag }}
          name: ${{ steps.ver.outputs.tag }}
          body: ${{ inputs.notes }}
          files: MediaKeyControl.zip
